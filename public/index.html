<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Real-Time File Sharing</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .container { max-width: 600px; margin: auto; }
    button { padding: 10px; margin: 5px; cursor: pointer; }
    #filePreview { margin-top: 10px; }
    #progressBar { width: 100%; height: 20px; background: #eee; }
    #progress { height: 100%; width: 0%; background: green; }
    #receivedFiles { margin-top: 20px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Real-Time File Sharing</h2>
    <button onclick="createRoom()">Create Room</button>
    <button onclick="joinRoom()">Join Room</button>
    <p>Room ID: <span id="roomId">-</span></p>
    <p>Total Devices Connected: <span id="deviceCount">0</span></p>

    <input type="file" id="fileInput" onchange="previewFile()" />
    <div id="filePreview"></div>
    <button onclick="sendFile()">Send</button>
    <div id="progressBar"><div id="progress"></div></div>

    <div id="receivedFiles">
      <h3>Received Files</h3>
      <ul id="fileList"></ul>
    </div>
  </div>

<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io('https://file-share-oiww.onrender.com'); // âœ… use your actual render URL
    let currentRoom = null;
    let selectedFile = null;

    function createRoom() {
      const roomId = Math.floor(100000 + Math.random() * 900000).toString();
      currentRoom = roomId;
      document.getElementById('roomId').textContent = roomId;
      socket.emit('create-room', roomId);
    }

    function joinRoom() {
      const roomId = prompt('Enter Room ID:');
      if (roomId) {
        currentRoom = roomId;
        document.getElementById('roomId').textContent = roomId;
        socket.emit('join-room', roomId);
      }
    }

    socket.on('update-count', count => {
      document.getElementById('deviceCount').textContent = count;
    });

    function previewFile() {
      const file = document.getElementById('fileInput').files[0];
      selectedFile = file;
      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const preview = document.getElementById('filePreview');
          preview.innerHTML = `<p><strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)</p>`;
          if (file.type.startsWith('image/')) {
            preview.innerHTML += `<img src="${reader.result}" alt="preview" width="100" />`;
          }
        };
        reader.readAsDataURL(file);
      }
    }

    function sendFile() {
      if (!selectedFile || !currentRoom) return alert('Select a file and join a room first.');

      const reader = new FileReader();
      reader.onload = e => {
        const arrayBuffer = e.target.result;
        const chunkSize = 64 * 1024;
        let offset = 0;
        let progress = document.getElementById('progress');

        function sendChunk() {
          const chunk = arrayBuffer.slice(offset, offset + chunkSize);
          socket.emit('file-chunk', {
            room: currentRoom,
            name: selectedFile.name,
            size: selectedFile.size,
            type: selectedFile.type,
            data: chunk,
            isLast: offset + chunkSize >= arrayBuffer.byteLength
          });
          offset += chunkSize;
          progress.style.width = `${(offset / arrayBuffer.byteLength) * 100}%`;

          if (offset < arrayBuffer.byteLength) {
            setTimeout(sendChunk, 10);
          }
        }

        sendChunk();
      };
      reader.readAsArrayBuffer(selectedFile);
    }

    let receivedBuffers = {};

    socket.on('receive-file', ({ name, size, data, type, isLast, senderId }) => {
      if (!receivedBuffers[senderId]) receivedBuffers[senderId] = [];
      receivedBuffers[senderId].push(data);

      if (isLast) {
        const blob = new Blob(receivedBuffers[senderId]);
        const url = URL.createObjectURL(blob);
        const fileList = document.getElementById('fileList');
        const item = document.createElement('li');
        item.innerHTML = `<a href="${url}" download="${name}">${name}</a> (${(size / 1024).toFixed(2)} KB)`;
        fileList.appendChild(item);
        delete receivedBuffers[senderId];
      }
    });
  </script>
</body>
</html>
